<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Carrito - El Claustro</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
    {% include 'partials/header.html' %}

<div class="navbar">
    <h1>Carrito</h1>
    <a href="{% url 'menu' %}">Volver</a>
</div>

    <div class="container">
    <h1>Tu Pedido</h1>

    <h2>Resumen</h2>
    <div style="max-width:720px;display:flex;gap:18px;flex-wrap:wrap;">
        <div style="flex:1;min-width:320px">
            <div id="cart-container"></div>
        </div>
        <aside style="width:320px">
            <div class="card">
                <h3 style="margin-top:0">Opciones de entrega</h3>
                <label><input type="radio" name="delivery" value="pickup"> Recoger en local</label><br>
                <label><input type="radio" name="delivery" value="delivery"> Envío a domicilio</label>

                <h3 style="margin-top:12px">Método de pago</h3>
                <label><input type="radio" name="payment" value="cash"> Pago en efectivo</label><br>
                <label><input type="radio" name="payment" value="card"> Tarjeta (en el local)</label><br>
                <label><input type="radio" name="payment" value="online"> Pago online</label>

                <hr>
                <div style="display:flex;justify-content:space-between;padding:8px 0"><div>Subtotal</div><div id="subtotal">$0</div></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0"><div>Impuestos (10%)</div><div id="impuestos">$0</div></div>
                <div class="cart-total" style="padding-top:12px"><div>Total</div><div id="total">$0</div></div>

                <button id="finalize-btn" type="button" onclick="handleFinalize()" class="btn btn-primary btn-large checkout-btn" style="width:100%;margin-top:12px">Confirmar y Pagar</button>
            </div>
        </aside>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        if (typeof initCart === 'function') initCart();
        if (typeof loadCart === 'function') loadCart();
        if (typeof loadTotals === 'function') loadTotals();
        // debug availability
        console.log('DEBUG checkout: window.finalizeOrder =', typeof window.finalizeOrder);
    });
</script>

<script src="{% static 'js/main.js' %}"></script>

<script>
    // Si finalizeOrder no está disponible al cargar la página, intentar cargar main.js con bust de caché
    (function(){
        function ensureFinalize(){
            if(typeof window.finalizeOrder === 'function'){
                console.log('finalizeOrder disponible');
                return;
            }
            console.warn('finalizeOrder no disponible: intentando recargar main.js');
            const s = document.createElement('script');
            s.src = "{% static 'js/main.js' %}?v=" + Date.now();
            s.onload = function(){
                console.log('main.js recargado dinámicamente');
                if(typeof window.finalizeOrder !== 'function'){
                    console.error('Después de recargar, finalizeOrder sigue sin estar definido');
                }
            };
            s.onerror = function(e){
                console.error('Error al recargar main.js dinámicamente', e);
            };
            document.body.appendChild(s);
        }

        // Intentar después de DOMContentLoaded y también si el usuario hace click y la función no existe
        document.addEventListener('DOMContentLoaded', function(){
            setTimeout(ensureFinalize, 200);
        });

        // Note: click handling is centralized in handleFinalize(), do not attach extra handlers here.
    })();
</script>

<script>
    // Handler robusto que usa finalizeOrder si existe, o ejecuta fallback local
    function handleFinalize(){
        // Try direct call first
        if(typeof window.finalizeOrder === 'function'){
            try{ window.finalizeOrder(); return; }catch(e){ console.error('Error ejecutando finalizeOrder:', e); }
        }

        // If not available, attempt to load main.js dynamically once, then call finalizeOrder if it appears.
        if(window._mainJsLoading){
            // Already attempting load; wait a bit then fallback
            setTimeout(function(){
                if(typeof window.finalizeOrder === 'function'){
                    try{ window.finalizeOrder(); return; }catch(e){ console.error('Error ejecutando finalizeOrder tras recarga:', e); }
                }
                // final fallback
                doCheckoutFallback();
            }, 600);
            return;
        }

        // Start loading main.js dynamically
        window._mainJsLoading = true;
        const s = document.createElement('script');
        s.src = "{% static 'js/main.js' %}?v=" + Date.now();
        s.onload = function(){
            console.log('main.js recargado dinámicamente desde handleFinalize');
            window._mainJsLoading = false;
            if(typeof window.finalizeOrder === 'function'){
                try{ window.finalizeOrder(); return; }catch(e){ console.error('Error ejecutando finalizeOrder tras recarga:', e); }
            }
            doCheckoutFallback();
        };
        s.onerror = function(e){
            window._mainJsLoading = false;
            console.error('Error al recargar main.js dinámicamente', e);
            doCheckoutFallback();
        };
        document.body.appendChild(s);
    }

    function doCheckoutFallback(){
        try{
            const delivery = document.querySelector('input[name="delivery"]:checked');
            const payment = document.querySelector('input[name="payment"]:checked');
            if(!delivery){ alert('Selecciona si vas a recoger o deseas entrega'); return; }
            if(!payment){ alert('Selecciona un método de pago'); return; }

            const deliveryVal = delivery.value;
            const paymentVal = payment.value;
            localStorage.setItem('deliveryMethod', deliveryVal);
            localStorage.setItem('paymentMethod', paymentVal);
            localStorage.setItem('pedidoConfirmado', 'true');
            localStorage.setItem('fechaPedido', new Date().toLocaleString('es-CO', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' }));

            try{ localStorage.setItem('cart', JSON.stringify([])); }catch(e){ console.error('No se pudo limpiar carrito en fallback', e); }
            window.location.href = '/estado/';
        }catch(err){
            console.error('Error en fallback handleFinalize', err);
            alert('Ocurrió un error al procesar el pago. Por favor recarga la página e inténtalo de nuevo.');
        }
    }
</script>

</body>
</html>

